# Delivery Service ‚Äî Test Task (Citadello)

–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å `delivery`, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–ª—É–∂–± (–°–î–≠–ö, Boxberry –∏ –¥—Ä.).  
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ **NestJS**, –ø–æ—Å—Ç—Ä–æ–µ–Ω –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º **–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã** –∏ **EDA (Event-Driven Architecture)**.  
–ü—Ä–æ–µ–∫—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å, –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

---

## üéØ –¶–µ–ª–∏ —Å–µ—Ä–≤–∏—Å–∞

- –ü–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –∫–æ—Ä–∑–∏–Ω–µ –∏ –∞–¥—Ä–µ—Å–µ –¥–æ—Å—Ç–∞–≤–∫–∏.
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏.
- –î–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ (–ø–∞–¥–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ ‚â† –æ—à–∏–±–∫–∞ –≤—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞).
- –ë—ã—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º –∏ –ª–µ–≥–∫–æ –ø–æ–¥–∫–ª—é—á–∞–µ–º—ã–º –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–º.
- –ü–æ–∑–≤–æ–ª—è—Ç—å –ø–æ–¥–∫–ª—é—á–∞—Ç—å –Ω–æ–≤—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞.

---

# 1. API —Å–µ—Ä–≤–∏—Å–∞

–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç:

## **POST `/v1/shipping/options`**

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞

\`\`\`json
{
"cart": {
"weightKg": 2.5,
"dimensionsCm": {
"length": 30,
"width": 20,
"height": 15
},
"totalPrice": 3500
},
"destination": {
"country": "RU",
"city": "–ú–æ—Å–∫–≤–∞",
"postalCode": "101000"
},
"currency": "RUB"
}
\`\`\`

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞

\`\`\`json
{
"options": [
{
"providerCode": "mock-cdek",
"serviceName": "Mock CDEK Standard",
"deliveryType": "courier",
"price": 300,
"currency": "RUB",
"estimatedDays": { "min": 2, "max": 4 }
},
{
"providerCode": "mock-boxberry",
"serviceName": "Mock Boxberry City Tariff",
"deliveryType": "pickup",
"price": 300,
"currency": "RUB",
"estimatedDays": { "min": 3, "max": 6 }
}
],
"providerErrors": [
{
"providerCode": "mock-boxberry",
"message": "Destination city is not supported"
}
]
}
\`\`\`

---

# 2. –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å

- **NestJS** + —Å—Ç—Ä–æ–≥–∞—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å.
- –ü–∞—Ç—Ç–µ—Ä–Ω—ã **Strategy** (–∫–∞–∂–¥—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è).
- –ü–∞—Ç—Ç–µ—Ä–Ω **Registry** (–µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤).
- **EDA** —á–µ—Ä–µ–∑ RabbitMQ.
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏: Delivery, Providers, Events, Infra, Shared.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

\`\`\`
src/
main.ts
app.module.ts

delivery/
delivery.module.ts
api.controller.ts
core.service.ts

providers/
providers.module.ts
mock-cdek.service.ts
mock-boxberry.service.ts

events/
events.module.ts
publisher.service.ts
subscriber.controller.ts

infra/
infra.module.ts
rmq.service.ts

shared/
shared.module.ts
dto/
types/
\`\`\`

---

# 3. –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

–ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:

\`\`\`ts
export interface ShippingProvider {
readonly code: string;
calculateOptions(req: CalculateDeliveryRequest): Promise<DeliveryOption[]>;
}
\`\`\`

–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `providers/<–∏–º—è>.service.ts`.
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `ShippingProvider`.
3. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤ –º–∞—Å—Å–∏–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π —Ñ–∞–±—Ä–∏–∫–æ–π `ProvidersModule`.

**–î–æ–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ.**

---

# 4. –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

### ‚úî –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
–ß–µ—Ä–µ–∑ Promise.all.

### ‚úî –¢–∞–π–º–∞—É—Ç –Ω–∞ –∫–∞–∂–¥—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
–ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä ¬´–≤–∏—Å–∏—Ç¬ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ *—Ç–æ–ª—å–∫–æ –ø–æ –Ω–µ–º—É*.

### ‚úî –ß–∞—Å—Ç–∏—á–Ω–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è
–û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

### ‚úî –ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫
–õ—é–±–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Üí `providerErrors[]`.

### ‚úî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å –ø–æ–¥ Circuit Breaker
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å CB –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API.

---

# 5. Event-Driven Architecture (EDA)

–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –≥–∏–±—Ä–∏–¥:

- –æ–±—ã—á–Ω—ã–π NestJS HTTP-—Å–µ—Ä–≤–µ—Ä,
- –∏ NestJS Microservice Transport (RabbitMQ).

## –°–æ–±—ã—Ç–∏–µ: `delivery.options.requested`

\`\`\`json
{
"orderId": "123",
"cart": { "weightKg": 2 },
"destination": { "city": "–ú–æ—Å–∫–≤–∞", "country": "RU" }
}
\`\`\`

## –°–æ–±—ã—Ç–∏–µ: `delivery.options.calculated`

\`\`\`json
{
"orderId": "123",
"options": [
{ "providerCode": "mock-cdek", "price": 300 }
]
}
\`\`\`

---

# 6. Mock-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

## MockCdekProvider
- –§–æ—Ä–º—É–ª–∞: `ceil(weightKg) * 100`.

## MockBoxberryProvider
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º:

| –ì–æ—Ä–æ–¥              | –¶–µ–Ω–∞ |
|--------------------|------|
| –ú–æ—Å–∫–≤–∞             | 300  |
| –ö–∞–∑–∞–Ω—å             | 500  |
| –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥    | 400  |

---

# 7. Unit-—Ç–µ—Å—Ç—ã

–ü–æ–∫—Ä—ã–≤–∞—é—Ç:

- —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ –≤–µ—Å—É (MockCdekProvider),
- –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ (MockBoxberryProvider).

–ó–∞–ø—É—Å–∫:

\`\`\`bash
npm test
\`\`\`

---

# 8. Docker –∏ docker-compose

–°–µ—Ä–≤–∏—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω.

## –ó–∞–ø—É—Å–∫

\`\`\`bash
docker-compose up --build
\`\`\`

## –ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã:

- Swagger ‚Äî http://localhost:3000/docs
- HTTP API ‚Äî http://localhost:3000/v1/shipping/options
- RabbitMQ UI ‚Äî http://localhost:15672 (guest / guest)

## –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ API:

\`\`\`bash
curl -X POST http://localhost:3000/v1/shipping/options \
-H "Content-Type: application/json" \
-d '{
"cart": { "weightKg": 2.5 },
"destination": { "country": "RU", "city": "–ú–æ—Å–∫–≤–∞" }
}'
\`\`\`

---

# 9. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∏–∑–Ω–µ—Å-—Ü–µ–ª—è–º Citadello

- ‚úî –ü—Ä–æ—Å—Ç–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–ª—É–∂–± –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚úî –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ EDA
- ‚úî –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ —á–∞—Å—Ç–∏—á–Ω–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è
- ‚úî –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –∏–∑–æ–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- ‚úî –õ—ë–≥–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

---

# 10. –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (CDEK, Boxberry, –ü–†, –Ø–Ω–¥–µ–∫—Å).
- –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –≤ –ë–î; –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ.
- Circuit Breaker, retry, rate limiting.
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤.
- –ú–µ—Ç—Ä–∏–∫–∏ (Prometheus), —Ç—Ä–µ–π—Å–∏–Ω–≥ (OpenTelemetry).
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (API-key –∏–ª–∏ JWT).
- –ú—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å: —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤.

---
